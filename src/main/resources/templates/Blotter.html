<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay Blotter</title>
    <link rel="stylesheet" th:href="@{/css/Blotter.css}">
    <link rel="icon" href="/favicon.png" type="image/png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        // Prevent caching
        if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_BACK_FORWARD) {
            location.replace('/login?expired');
        }

        // Session check on load
        document.addEventListener('DOMContentLoaded', checkSession);
        
        // Check on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) checkSession();
        });

        function checkSession() {
            fetch('/api/check-session', {
                credentials: 'include',
                headers: { 'Cache-Control': 'no-cache' }
            })
            .then(response => {
                if (!response.ok) window.location.replace('/login?expired');
            })
            .catch(() => window.location.replace('/login?expired'));
        }

        // Prevent back button
        window.addEventListener('popstate', () => {
            checkSession();
        });
    </script>
</head>
<body>

    <div class="overlay" id="deleteOverlay"></div>
    <div class="delete-modal" id="deleteModal">
        <div class="delete-modal-header">
            <h2>Confirm Deletion</h2>
        </div>
        <div class="delete-modal-body">
            <p>Are you sure you want to delete this record?</p>
        </div>
        <div class="delete-modal-footer">
            <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
            <button class="confirm-btn" onclick="confirmDelete()">Confirm</button>
        </div>
    </div>

    <div class="container">
        <div class="form-section">
            <div class="LogoName">
                <div class="Logo">
                    <a th:href="@{/Home}">
                        <img th:src="@{/image/Logo.png}" class="logo" alt="Logo">                        
                    </a>
                </div>
                <div class="Name">
                    <h3>Barangay Blotter</h3>
                </div>
            </div>
            <br>
            <form th:action="@{/submit}" method="post">
                <div class="FormContainer">
                    <div class="One">
                        <label for="respondent">Respondent's Name:</label>
                        <input type="text" id="respondent" name="respondent" required>

                        <label for="caseNumber">Case Number:</label>
                        <input type="text" id="caseNumber" name="caseNumber" placeholder="(Optional: autogenerated if empty)">  

                        <label for="location">Location of Incident:</label>
                        <input type="text" id="location" name="location" required>

                        <label for="description">Description of Incident:</label>
                        <textarea id="description" name="description" required></textarea>

                        <label for="recordedBy">Recorded By:</label>
                        <input type="text" id="recordedBy" name="recordedBy" required>
                    </div>
                    <div class="Two">
                        <label for="date">Date and Time:</label>
                        <input type="datetime-local" id="date" name="date" required>

                        <label for="complainant">Complainant's Name:</label>
                        <input type="text" id="complainant" name="complainant" required>

                        <label for="issued">Issue</label>
                        <select name="issued" id="issued">
                            <option value="None">None</option>
                            <option value="Medico-Legal">Medico-Legal</option>
                            <option value="CCTV">CCTV</option>
                        </select>
                    </div>
                </div>

                <button type="submit">SUBMIT</button>
            </form>
        </div>
        <div class="records-section">
            <h1>BARANGAY BLOTTER RECORDS</h1>

            <div class="search-bar">
                <label for="search">Search: </label>
                <input type="text" id="search" placeholder="Search records by Compliant..." onkeyup="filterRecords()">
            </div>
            
            <div class="filter">
                <label for="filter">Filter: </label>
                <select id="filter" onchange="filterRecords()"> <!-- Added onchange event to trigger filtering -->
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="resolved">Resolved</option>
                </select>
            </div>
            
            <div class="table-container" style="max-height: 70vh; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Complainant</th>
                            <th>Respondent</th>
                            <th>Incident</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable">
                        <tr th:each="record : ${records}" 
                        th:data-id="${record.id}"
                        th:data-case-number="${record.caseNumber}" 
                        th:data-location="${record.location}" 
                        th:data-date="${record.date}" 
                        th:data-recorded-by="${record.recordedBy}"
                        th:data-issued="${record.issued}">
                            <td th:text="${record.complainant}">John Doe</td>
                            <td th:text="${record.respondent}">Jane Smith</td>
                            <td th:text="${record.description}" class="descriptionRow">description of incident</td>
                            <td>
                                <select onchange="updateStatus(this)">
                                    <option value="pending" th:selected="${record.status == 'Pending'}">Pending</option>
                                    <option value="resolved" th:selected="${record.status == 'Resolved'}">Resolved</option>
                                </select>
                            </td>                            
                            <td class="buttonBoth">
                                <button class="view-btn" onclick="viewRecord(this)">View</button>
                                <button class="delete-btn" onclick="prepareDelete(this)">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                    
                </table>
            </div>
        </div>        
    </div>

    <!-- Modal -->
    <div class="overlay" id="overlay"></div>
    <div class="modal" id="modal">
        <div class="modal-header">
            <h2>Record Details</h2>
            <button class="close-btn" onclick="closeModal()">x</button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Content will be dynamically filled -->
        </div>
    </div>

    <script>
        let deleteRow = null; // Variable to hold the row to delete

        // Function to show the delete confirmation modal
        function prepareDelete(button) {
            // Store the row to delete
            deleteRow = button.closest('tr');
            
            // Show the custom delete modal
            document.getElementById('deleteModal').style.display = 'block';
            document.getElementById('deleteOverlay').style.display = 'block';
        }

        // Function to confirm deletion
        function confirmDelete() {
            if (deleteRow) {
                const recordId = deleteRow.getAttribute('data-id'); // Get the record ID from data-id attribute
                
                // Make the DELETE request
                fetch(`/api/blotter/record/${recordId}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        // If successful, remove the row from the table
                        deleteRow.remove();
                    } else {
                        alert('Failed to delete the record.');
                    }
                    closeDeleteModal(); // Close the modal after deletion
                })
                .catch(error => {
                    console.error('Error deleting the record:', error);
                    alert('An error occurred while deleting the record.');
                    closeDeleteModal(); // Close the modal if there's an error
                });
            }
        }

        // Function to close the delete confirmation modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('deleteOverlay').style.display = 'none';
            deleteRow = null; // Reset the delete row variable
        }

        // Function to view a record and display all information in the modal
        function viewRecord(button) {
            const row = button.closest('tr');
            const complainant = row.cells[0].innerText;
            const respondent = row.cells[1].innerText;
            const description = row.cells[2].innerText;
            const status = row.cells[3].querySelector('select').value;

            // Get additional hidden data from data attributes (set in each <tr> for the modal)
            const caseNumber = row.dataset.caseNumber;
            const location = row.dataset.location;
            const date = row.dataset.date;
            const recordedBy = row.dataset.recordedBy;
            const issued = row.dataset.issued;

            // Fill modal with record details
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <p><strong>Complainant:</strong> ${complainant}</p>
                <p><strong>Respondent:</strong> ${respondent}</p>
                <p><strong>Description of Incident:</strong> ${description}</p>
                <p><strong>Case Number:</strong> ${caseNumber}</p>
                <p><strong>Location:</strong> ${location}</p>
                <p><strong>Date:</strong> ${date}</p>
                <p><strong>Recorded By:</strong> ${recordedBy}</p>
                <p><strong>Issue:</strong> ${issued}</p>
                <p><strong>Status:</strong> ${status}</p>
            `;

            // Show modal and overlay
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // Function to delete a record using AJAX
// Function to delete a record
        function deleteRecord(button) {
            const row = button.closest('tr');
            const recordId = row.getAttribute('data-id'); // Get the ID from the data-id attribute

            if (confirm('Are you sure you want to delete this record?')) {
                fetch(`/api/blotter/record/${recordId}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        // If deletion is successful, remove the row from the table
                        row.remove();
                    } else {
                        alert('Failed to delete the record.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting the record:', error);
                    alert('An error occurred while deleting the record.');
                });
            }
        }

        // Function to filter records based on the search query
        function filterRecords() {
            const searchQuery = document.getElementById('search').value.toLowerCase();  // Get the search query (converted to lowercase)
            const filterStatus = document.getElementById('filter').value; // Get the selected filter value
            const rows = document.querySelectorAll('#recordsTable tr'); // Get all rows in the table
            
            rows.forEach(row => {
                const complainant = row.cells[0].innerText.toLowerCase(); // Get complainant's name (column 0)
                const status = row.cells[3].querySelector('select').value; // Get status from the select dropdown

                // Check if the row matches both the search query and the selected filter
                const matchesSearch = complainant.includes(searchQuery);
                const matchesFilter = (filterStatus === 'all') || (status === filterStatus);
                
                if (matchesSearch && matchesFilter) {
                    row.style.display = '';  // Show row if it matches both criteria
                } else {
                    row.style.display = 'none';  // Hide row if it doesn't match
                }
            });
        }

        // Function to update the status
        function updateStatus(selectElement) {
            const row = selectElement.closest('tr'); // Get the row containing the select element
            const recordId = row.getAttribute('data-id'); // Get the record ID from the data-id attribute
            const newStatus = selectElement.value; // Get the new status from the selected value
        
            // Send the update request to the server
            fetch(`/api/blotter/record/${recordId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus }),
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Error response:', response);
                    alert('Failed to update status.');
                    // Optionally revert the change if the update fails
                    selectElement.value = selectElement.dataset.originalStatus;
                }
            })
            .catch(error => {
                console.error('Error updating status:', error);
                alert('An error occurred while updating status.');
            });
        }
        
        



    </script>
</body>
</html>
